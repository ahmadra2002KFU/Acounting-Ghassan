# النظام المحاسبي - Accounting System

نظام محاسبي متكامل مع قاعدة بيانات SQLite وواجهة برمجية Flask.

## المميزات

### المحاسبة
- ✅ نظام القيد المزدوج (Double-Entry Bookkeeping)
- ✅ تكلفة المخزون بطريقة FIFO
- ✅ حساب ضريبة القيمة المضافة 15% (السعودية)
- ✅ دعم متعدد الفروع ومراكز التكلفة
- ✅ شجرة حسابات موسعة (70+ حساب)

### المستندات
- فاتورة مبيعات (مع حساب COGS تلقائيًا)
- فاتورة مشتريات (مع إضافة للمخزون)
- سند قبض
- سند صرف
- قيد يومية
- مرتجع مبيعات
- مرتجع مشتريات

### التقارير
- دفتر اليومية (Journal)
- دفتر الأستاذ (Ledger)
- ميزان المراجعة (Trial Balance)
- قائمة الدخل (Income Statement)
- قائمة المركز المالي (Balance Sheet)

### البيانات الأساسية
- 10 فروع (الرياض، جدة، مكة، إلخ)
- 20 مركز تكلفة (مبيعات/إدارة لكل فرع)
- 20 صنف (إلكترونيات وأدوات منزلية)
- قائمة أسعار افتراضية
- ربط محاسبي تلقائي للأصناف

## متطلبات التشغيل

- Python 3.8+
- pip

## التثبيت والتشغيل

### 1. تثبيت المكتبات المطلوبة

```bash
cd backend
pip install -r requirements.txt
```

### 2. إنشاء قاعدة البيانات وتعبئتها بالبيانات التجريبية

```bash
python seed_data.py
```

سيتم إنشاء:
- قاعدة بيانات SQLite في `backend/accounting.db`
- 10 فروع
- 20 مركز تكلفة
- 20 صنف مع أسعار
- 70+ حساب في شجرة الحسابات
- أكواد ضريبة القيمة المضافة

### 3. تشغيل الخادم

```bash
python app.py
```

الخادم سيعمل على: `http://localhost:5000`

### 4. فتح التطبيق

افتح المتصفح على:
```
http://localhost:5000
```

أو افتح الملف:
```
index.html
```

(تأكد أن الخادم يعمل أولاً)

## البنية المعمارية

### Backend (Flask + SQLite)

```
backend/
├── app.py              # تطبيق Flask الرئيسي وجميع API endpoints
├── models.py           # نماذج SQLAlchemy للجداول
├── services.py         # منطق العمليات المحاسبية (FIFO, Posting, Reports)
├── seed_data.py        # سكريبت تعبئة البيانات التجريبية
├── requirements.txt    # المكتبات المطلوبة
└── accounting.db       # قاعدة البيانات (يتم إنشاؤها تلقائيًا)
```

### Frontend (HTML + JavaScript)

```
index.html             # الواجهة الأمامية (تستخدم fetch API)
accounting_app_offline_v2.html  # النسخة القديمة (localStorage فقط)
```

## API Endpoints

### Master Data
- `GET /api/config` - إعدادات النظام
- `GET /api/branches` - الفروع
- `GET /api/cost-centers` - مراكز التكلفة
- `GET /api/currencies` - العملات
- `GET /api/items` - الأصناف
- `GET /api/prices` - قائمة الأسعار
- `GET /api/item-mapping` - الربط المحاسبي
- `GET /api/coa` - شجرة الحسابات
- `GET /api/tax-codes` - أكواد الضريبة

### Vouchers
- `POST /api/vouchers/sale` - ترحيل فاتورة مبيعات
- `POST /api/vouchers/purchase` - ترحيل فاتورة مشتريات
- `POST /api/vouchers/receipt` - ترحيل سند قبض
- `POST /api/vouchers/payment` - ترحيل سند صرف
- `POST /api/vouchers/journal` - ترحيل قيد يومية
- `POST /api/vouchers/return-sale` - ترحيل مرتجع مبيعات
- `POST /api/vouchers/return-purchase` - ترحيل مرتجع مشتريات

### Reports
- `GET /api/journal` - قيود اليومية
- `GET /api/documents` - المستندات
- `GET /api/reports/journal` - تقرير اليومية
- `GET /api/reports/ledger?account=XXX` - تقرير الأستاذ
- `GET /api/reports/trial-balance` - ميزان المراجعة
- `GET /api/reports/income-statement` - قائمة الدخل
- `GET /api/reports/balance-sheet` - الميزانية

### Backup/Restore
- `GET /api/backup/export` - تصدير البيانات
- `POST /api/backup/import` - استيراد البيانات
- `POST /api/reset` - إعادة تعيين البيانات

## الجداول في قاعدة البيانات

1. **config** - إعدادات النظام
2. **branches** - الفروع
3. **cost_centers** - مراكز التكلفة
4. **currencies** - العملات
5. **items** - الأصناف
6. **prices** - الأسعار
7. **item_gl_mapping** - الربط المحاسبي للأصناف
8. **chart_of_accounts** - شجرة الحسابات
9. **tax_codes** - أكواد الضريبة
10. **journal_entries** - القيود المحاسبية
11. **documents** - المستندات
12. **document_lines** - تفاصيل المستندات
13. **stock_batches** - دفعات المخزون (FIFO)
14. **document_sequences** - تسلسل أرقام المستندات

## أمثلة على الاستخدام

### 1. ترحيل فاتورة مبيعات

1. اذهب إلى تبويب "المستندات"
2. اضغط "فاتورة مبيعات"
3. اختر التاريخ، الفرع، المركز
4. اختر الصنف (سيتم تعبئة السعر تلقائيًا)
5. أدخل الكمية
6. اضغط "ترحيل"

النظام سيقوم بـ:
- ترحيل الإيرادات
- حساب ضريبة القيمة المضافة
- حساب تكلفة المبيعات (COGS) من FIFO
- تخفيض المخزون

### 2. ترحيل فاتورة مشتريات

1. اضغط "فاتورة مشتريات"
2. أدخل البيانات
3. اضغط "ترحيل"

النظام سيقوم بـ:
- إضافة دفعة للمخزون (FIFO)
- ترحيل المشتريات وضريبة المدخلات
- ترحيل الدائنين

### 3. عرض التقارير

- **دفتر اليومية**: يمكن التصفية حسب التاريخ/الفرع/المركز
- **دفتر الأستاذ**: أدخل رقم الحساب
- **ميزان المراجعة**: يعرض جميع الحسابات مع الأرصدة
- **قائمة الدخل**: تحسب صافي الربح تلقائيًا
- **الميزانية**: تتحقق من توازن المعادلة المحاسبية

## الميزات التقنية

### FIFO Inventory Costing
- يتم تخزين كل دفعة شراء مع التكلفة
- عند البيع، يتم استهلاك أقدم دفعة أولاً
- حساب تكلفة المبيعات (COGS) تلقائيًا

### Auto Document Numbering
- كل نوع مستند له تسلسل خاص
- AR-000001, AR-000002 (مبيعات)
- AP-000001, AP-000002 (مشتريات)
- RC-000001 (قبض)
- PY-000001 (صرف)
- JV-000001 (يومية)

### Double-Entry Validation
- كل قيد محاسبي يجب أن يكون متوازن
- المدين = الدائن

### VAT Handling
- حساب تلقائي 15%
- حسابات منفصلة للمخرجات والمدخلات
- دعم Reverse Charge Mechanism (RCM)

## الأمان

⚠️ **ملاحظة**: هذا النظام PoC (Proof of Concept) فقط
- لا يوجد نظام مصادقة
- لا توجد تشفير للبيانات الحساسة
- لا يُنصح باستخدامه في بيئة إنتاجية بدون تحسينات أمنية

## الترخيص

MIT License - استخدام حر

## الدعم

للمساعدة أو الإبلاغ عن مشاكل، يرجى التواصل مع المطور.
